!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("react"),require("rxjs"),require("rxjs/operators"),require("prop-types")):"function"==typeof define&&define.amd?define(["exports","react","rxjs","rxjs/operators","prop-types"],n):n((e=e||self)["formiz-core"]={},e.React,e.rxjs,e.operators,e.PropTypes)}(this,(function(e,n,r,t,i){"use strict";function u(){return(u=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e}).apply(this,arguments)}function o(e,n){if(null==e)return{};var r,t,i={},u=Object.keys(e);for(t=0;t<u.length;t++)n.indexOf(r=u[t])>=0||(i[r]=e[r]);return i}function a(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof n?n:String(n)}i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;var s=function(e){return e&&"object"==typeof e&&e.constructor===Object},c=function(e){return Object.keys(e).reduce((function(e,n){return l(n,e)}),e)},l=function(e,n){var r,t;if(e.indexOf(".")<0&&e.indexOf("[")<0)return n;var i=n[e],l=o(n||{},[e].map(a)),d=e.split("."),f=d[0],v=d.slice(1);if(f.match(/\[([0-9]*)\]$/g)){var p,m=f.split(/(\[|\])/g),b=m[0],g=m[2],S=n[b]||[];if(v.length){var y,V=u({},n[b]&&s(n[b][g])?n[b][g]:{},((y={})[v.join(".")]=i,y));S[g]=c(V)}else S[g]=i;return u({},l,((p={})[b]=S,p))}var h=u({},s(n[f])?n[f]:{},((r={})[v.join(".")]=i,r));return u({},l,((t={})[f]=c(h),t))},d=function(e){var n=(e||[]).filter((function(e){return e.isEnabled})).reduce((function(e,n){var r;return u({},e,((r={})[n.name]=n.value,r))}),{});return c(n)},f=function(){return"form-"+Math.random().toString(36).substr(2,9)},v=function(e){var r=n.useRef(e);return r.current=e,r},p=function(e,i){void 0===i&&(i=100);var u=n.useRef(new r.Subject);return{push:function(n){u.current.next(null!=n?n:e.current)},subscription:u.current.pipe(t.throttleTime(i,void 0,{leading:!0,trailing:!0}))}},m=function(e,i){void 0===i&&(i=100);var u=n.useRef(new r.BehaviorSubject(e.current));return{push:function(n){u.current.next(null!=n?n:e.current)},subscription:u.current.pipe(t.throttleTime(i,void 0,{leading:!0,trailing:!0}))}},b={id:f(),resetKey:0,isSubmitted:!1,isValidating:!1,isValid:!0,isPristine:!0,steps:[],initialStepName:null,navigatedStepName:null},g=n.createContext({}),S=function(){return n.useContext(g)},y=function(e){var n=e.navigatedStepName||e.initialStepName;return e.steps.find((function(e){return e.name===n}))},V=new Error("A Formiz field always needs to be a children of a `<Formiz>` component."),h=new Error("A Formiz field (component using a useField hook) always needs a `name` props."),E=new Error("A <FormizStep> always needs to be a children of a `<Formiz>` component."),N=new Error("A <FormizStep> always needs a `name` props."),x=n.createContext({}),O={name:i.string.isRequired,debounce:i.number,defaultValue:i.any,formatValue:i.func,onChange:i.func,required:i.oneOfType([i.bool,i.node]),validations:i.arrayOf(i.shape({rule:i.func,message:i.node,deps:i.arrayOf(i.any)})),asyncValidations:i.arrayOf(i.shape({rule:i.func,message:i.node,deps:i.arrayOf(i.any)})),keepValue:i.bool},P={debounce:100,defaultValue:null,formatValue:function(e){return e},onChange:function(){},required:!1,validations:[],asyncValidations:[],keepValue:!1},F=function(e,n){return!0===e||e===n||"object"==typeof e&&!!e[n]};e.Formiz=function(e){var r=e.autoForm,t=void 0!==r&&r,i=e.children,o=void 0===i?"":i,a=e.connect,s=void 0===a?{}:a,c=e.id,l=void 0===c?f():c,S=e.onChange,V=void 0===S?function(){}:S,h=e.onSubmit,E=void 0===h?function(){}:h,N=e.onValidSubmit,x=void 0===N?function(){}:N,O=e.onInvalidSubmit,P=void 0===O?function(){}:O,F=e.onValid,j=void 0===F?function(){}:F,R=e.onInvalid,w=void 0===R?function(){}:R,J=n.useRef(u({},b,{id:l})),k=n.useRef([]),z=n.useRef({}),C=v(s.__connect__||function(){}),K=v(V),U=v(E),_=v(x),q=v(P),T=v(j),M=v(w),D=m(J),I=m(k),A=p(k),B=p(J),L=function(){var e=k.current.every((function(e){var n,r,t;return!(null==e||null===(n=e.errors)||void 0===n?void 0:n.length)&&!(null==e||null===(r=e.asyncErrors)||void 0===r?void 0:r.length)&&!(null==e||null===(t=e.externalErrors)||void 0===t?void 0:t.length)}));return e?T.current():M.current(),e},$=function(e){return k.current.filter((function(n){return n.stepName===e})).every((function(e){return null==e?void 0:e.isPristine}))},G=function(e){return k.current.filter((function(n){return n.stepName===e})).some((function(e){return null==e?void 0:e.isValidating}))},H=function(e){var n=u({},J.current,e);JSON.stringify(n)!==JSON.stringify(J.current)&&(J.current=n,D.push())},Q=function(e){var n=J.current.steps.filter((function(e){return e.isEnabled})),r=n.findIndex((function(n){return n.name===e}));r<0||H({navigatedStepName:n[r].name})},W=function(){var e=J.current.steps.filter((function(e){return e.isEnabled})),n=e.findIndex((function(e){var n;return e.name===(null===(n=y(J.current))||void 0===n?void 0:n.name)}));n===e.length-1||Q(e[n+1].name)},X=function(e){e&&e.preventDefault(),H({isSubmitted:!0,steps:J.current.steps.map((function(e){return u({},e,{isSubmitted:!0})}))});var n=d(k.current);J.current.isValid&&!J.current.isValidating?_.current(n):q.current(n),U.current(n)},Y=function(){H({isValid:L(),isPristine:k.current.every((function(e){return null==e?void 0:e.isPristine})),isValidating:k.current.some((function(e){return null==e?void 0:e.isValidating})),steps:J.current.steps.map((function(e){return u({},e,{isValid:(n=e.name,k.current.filter((function(e){return e.stepName===n})).every((function(e){var n,r,t;return!(null==e||null===(n=e.errors)||void 0===n?void 0:n.length)&&!(null==e||null===(r=e.asyncErrors)||void 0===r?void 0:r.length)&&!(null==e||null===(t=e.externalErrors)||void 0===t?void 0:t.length)}))),isPristine:$(e.name),isValidating:G(e.name)});var n}))})},Z={submit:X,submitStep:function(e){var n,r;e&&e.preventDefault(),H({steps:J.current.steps.map((function(e){var n;return u({},e,{isSubmitted:e.name===(null===(n=y(J.current))||void 0===n?void 0:n.name)||e.isSubmitted})}))});var t=y(J.current);if((null==t?void 0:t.isValid)&&!(null==t?void 0:t.isValidating)){var i=J.current.steps.filter((function(e){return e.isEnabled})),o=null===(n=y(J.current))||void 0===n?void 0:n.name;(null===(r=i[i.length-1])||void 0===r?void 0:r.name)===o?X():W()}},setFieldsValues:function(e){void 0===e&&(e={}),k.current=function(e,n){if(void 0===n&&(n={}),!n)return e;var r=e.map((function(e){var r;return u({},e,{value:null!==(r=n[e.name])&&void 0!==r?r:e.value})}));return[].concat(r)}(k.current,e),A.push()},invalidateFields:function(e){void 0===e&&(e={}),k.current=function(e,n){if(void 0===n&&(n={}),!n)return e;var r=e.map((function(e){return u({},e,{externalErrors:n[e.name]?[n[e.name],e.externalErrors]:e.externalErrors})}));return[].concat(r)}(k.current,e),A.push()},getFieldStepName:function(e){var n,r;return null!==(n=null===(r=k.current.find((function(n){return e===n.name})))||void 0===r?void 0:r.stepName)&&void 0!==n?n:null},goToStep:Q,nextStep:W,prevStep:function(){var e=J.current.steps.filter((function(e){return e.isEnabled})),n=e.findIndex((function(e){var n;return e.name===(null===(n=y(J.current))||void 0===n?void 0:n.name)}));0===n||Q(e[n-1].name)},reset:function(){var e;H(u({},e=J.current,{resetKey:e.resetKey+1,isSubmitted:!1,isValid:!0,navigatedStepName:null,steps:e.steps.map((function(e){return u({},e,{isSubmitted:!1,isVisited:!1})}))})),z.current={},B.push()}},ee={formStateRef:J,fieldsRef:k,actions:{updateStep:function(e){H(function(e,n){if(!n||!n.name)return e;var r=e.steps.findIndex((function(e){return e.name===n.name})),t=e.steps[r],i=u({},t||{},n);if(JSON.stringify(i)===JSON.stringify(t))return e;var o=[].concat(e.steps);t?o[r]=i:o.push(i);var a=o.sort((function(e,n){return e.order-n.order})),s=a.filter((function(e){return e.isEnabled}));return u({},e,{initialStepName:s.length?s[0].name:null,steps:a})}(J.current,e)),Y()},unregisterStep:function(e){H(u({},function(e,n){return n?u({},e,{steps:e.steps.filter((function(e){return e.name!==n}))}):e}(J.current,e),{isValid:L()})),Y()},registerField:function(e){delete z.current[e.name],k.current=function(e,n){if(!n)return e;var r=e.find((function(e){return e.id===n.id})),t=e.filter((function(e){return e.id!==n.id}));return JSON.stringify(n)===JSON.stringify(r)?e:[].concat(t,[u({},n)])}(k.current,e),I.push(),K.current(d(k.current)),Y()},updateField:function(e){k.current=function(e,n){if(!n)return e;var r=e.find((function(e){return e.id===n.id})),t=e.filter((function(e){return e.id!==n.id}));return JSON.stringify(n)===JSON.stringify(r)?e:[].concat(t,[u({},n)])}(k.current,e),I.push(),K.current(d(k.current)),Y()},unregisterField:function(e,n){n&&(z.current[e.name]=e.value),k.current=function(e,n){if(!n)return e;var r=e.filter((function(e){return e.id!==n}));return[].concat(r)}(k.current,e.id),I.push(),K.current(d(k.current)),Y()}},formMethods:Z,keepValuesRef:z,subjects:{onFormUpdate:D,onFieldsUpdate:I,onExternalFieldsUpdate:A,onReset:B}};return n.useEffect((function(){C.current(ee)}),[]),n.createElement(g.Provider,{value:ee},t?n.createElement("form",{noValidate:!0,onSubmit:X},o):o)},e.FormizStep=function(e){var r,t=e.as,i=void 0===t?"div":t,a=e.children,s=e.name,c=e.label,l=e.order,d=e.isEnabled,f=void 0===d||d,v=e.style,p=void 0===v?{}:v,m=o(e,["as","children","name","label","order","isEnabled","style"]);if(!s)throw N;var g=S(),y=g.formStateRef,V=g.actions,h=g.subjects;if(!h||!V)throw E;var O=n.useState(null!==(r=null==y?void 0:y.current)&&void 0!==r?r:b),P=O[0],F=O[1],j=n.useState({name:s,label:c,isVisited:!1,order:null!=l?l:0}),R=j[0],w=j[1],J=P.navigatedStepName?P.navigatedStepName===s:P.initialStepName===s;return n.useEffect((function(){var e=h.onFormUpdate.subscription.subscribe(F);return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){P.navigatedStepName===s&&!R.isVisited&&J&&w((function(e){return u({},e,{isVisited:!0})}))})),n.useEffect((function(){V.updateStep(u({},R,{isEnabled:f}))}),[R,f]),n.useEffect((function(){return function(){V.unregisterStep(s)}}),[s]),f?n.createElement(x.Provider,{value:{name:s}},n.createElement(i,Object.assign({style:u({},p,{display:J?null:"none"})},m),f&&a)):null},e.fieldDefaultProps=P,e.fieldPropTypes=O,e.useField=function(e){var r,t,i,o,a,s=e.name,c=e.debounce,l=void 0===c?P.debounce:c,d=e.defaultValue,f=void 0===d?P.defaultValue:d,p=e.formatValue,m=void 0===p?P.formatValue:p,g=e.onChange,y=void 0===g?P.onChange:g,E=e.required,N=void 0===E?P.required:E,O=e.validations,F=void 0===O?P.validations:O,j=e.asyncValidations,R=void 0===j?P.asyncValidations:j,w=e.keepValue,J=void 0===w?P.keepValue:w;if(!s)throw h;var k=S(),z=k.formStateRef,C=k.actions,K=k.subjects,U=k.keepValuesRef;if(!K||!C||!U)throw V;var _=n.useRef(!0),q=n.useContext(x),T=null==q?void 0:q.name,M=n.useState(null!==(r=null==z?void 0:z.current)&&void 0!==r?r:b),D=M[0],I=M[1],A=null!==(t=null===(i=U.current)||void 0===i?void 0:i[s])&&void 0!==t?t:f,B=n.useState({id:"field-"+Math.random().toString(36).substr(2,9),resetKey:0,value:A,valueDebounced:A,errors:[],asyncErrors:[],externalErrors:[],isValidating:!1,isPristine:!0,isEnabled:!0}),L=B[0],$=B[1],G=v(L),H=v(s),Q=v(T),W=v(function(e,n){return n||""===n?[].concat(e,[{rule:function(e){return!!e||0===e},message:!0!==n?n:""}]):e}(F||[],N)),X=v(R||[]),Y=v(l),Z=v(y),ee=v(m),ne=v(f),re=v(J),te=D.navigatedStepName||D.initialStepName,ie=D.steps.find((function(e){return e.name===te}))||null;n.useEffect((function(){var e=K.onFormUpdate.subscription.subscribe(I);return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){var e=K.onExternalFieldsUpdate.subscription.subscribe((function(e){var n=e.find((function(e){return e.id===G.current.id}));n&&JSON.stringify(n)!==JSON.stringify(G.current)&&$(n)}));return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){var e=K.onReset.subscription.subscribe((function(){$((function(e){return u({},e,{error:[],externalErrors:[],resetKey:e.resetKey+1,isPristine:!0,value:ne.current})})),Z.current(ee.current(ne.current),ne.current)}));return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){var e=function(){try{var e=(W.current||[]).reduce((function(e,n){return n.rule(L.value)?e:[].concat(e,[n.message])}),[]),n=!e.length&&!!(X.current||[]).length;return $((function(r){return u({},r,{errors:e,asyncErrors:[],valueDebounced:r.value,isValidating:n})})),n?Promise.resolve(Promise.all((X.current||[]).map((function(e){try{return Promise.resolve(e.rule(L.value)).then((function(n){return u({},e,{isValid:n})}))}catch(e){return Promise.reject(e)}})))).then((function(e){if(_.current&&L.value===G.current.value){var n=e.reduce((function(e,n){return n.isValid?e:[].concat(e,[n.message])}),[]);$((function(e){return u({},e,{asyncErrors:n,isValidating:!1})}))}})):Promise.resolve()}catch(e){return Promise.reject(e)}};if(!Y.current)return e(),function(){};var n=setTimeout((function(){e()}),Y.current);return function(){return clearTimeout(n)}}),[JSON.stringify(L.value),JSON.stringify(null===(o=[].concat(F||[],R||[]))||void 0===o?void 0:o.reduce((function(e,n){return[].concat(e,n.deps||[],[n.message])}),[]))]),n.useEffect((function(){return C.registerField(u({},G.current,{name:H.current,stepName:Q.current,value:ee.current(G.current.value)})),function(){C.unregisterField(u({},G.current,{name:H.current,stepName:Q.current,value:ee.current(G.current.value)}),re.current)}}),[]),n.useEffect((function(){C.updateField(u({},L,{name:s,stepName:T,value:ee.current(L.value)}))}),[s,T,JSON.stringify(L)]),n.useEffect((function(){return function(){_.current=!1}}),[]);var ue,oe,ae=T&&ie&&te===T?ie.isSubmitted:D.isSubmitted,se=[].concat(L.externalErrors,L.asyncErrors,L.errors);return{errorMessage:se[0],errorMessages:se,id:(ue=(null==z||null===(a=z.current)||void 0===a?void 0:a.id)||"",oe=s,"formiz-"+ue+"-field-"+oe),isPristine:L.isPristine,isSubmitted:ae,isValid:!se.length,isValidating:L.isValidating,setValue:function(e){$((function(n){return u({},n,{externalErrors:[],value:e,isPristine:!1})})),Z.current(ee.current(e),e)},value:L.value,valueDebounced:L.valueDebounced,resetKey:L.resetKey}},e.useForm=function(e){var r,t,i,o,a=(void 0===e?{}:e).subscribe,s=void 0===a||a,c=S(),l=c.formStateRef,f=c.fieldsRef,p=c.subjects,m=n.useState(c.formMethods),g=m[0],y=m[1],V=n.useState(null!==(r=null==l?void 0:l.current)&&void 0!==r?r:b),h=V[0],E=V[1],N=n.useState(null!==(t=null==f?void 0:f.current)&&void 0!==t?t:[]),x=N[0],O=N[1],P=v(x),j=n.useRef([]),R=function(e){if(e&&F(s,"form")){var n=e.subscription.subscribe(E);j.current.push(n)}},w=function(e){if(e&&F(s,"fields")){var n="object"==typeof s&&"object"==typeof s.fields?s.fields:null,r=e.subscription.subscribe((function(e){var r=n?e.filter((function(e){return n.includes(e.name)})):e;JSON.stringify(P.current)!==JSON.stringify(r)&&O(r)}));j.current.push(r)}},J=n.useCallback((function(e){var n=e.subjects;y(e.formMethods),R(null==n?void 0:n.onFormUpdate),w(null==n?void 0:n.onFieldsUpdate)}),[]);n.useEffect((function(){R(null==p?void 0:p.onFormUpdate),w(null==p?void 0:p.onFieldsUpdate)}),[]),n.useEffect((function(){return function(){j.current.forEach((function(e){return null==e?void 0:e.unsubscribe()}))}}),[]);var k=h.steps.filter((function(e){return e.isEnabled})).map((function(e,n){var r=e.isSubmitted,t=e.isPristine,i=e.isValidating,u=e.isValid,o=e.isVisited;return{index:n,name:e.name,label:e.label,isPristine:null!=t&&t,isSubmitted:null!=r&&r,isValid:null!=u&&u,isValidating:null!=i&&i,isVisited:null!=o&&o}})).map((function(e,n){return u({},e,{index:n})})),z=k.find((function(e){return e.name===(h.navigatedStepName||h.initialStepName)}))||null;return u({},g,F(s,"form")?{resetKey:h.resetKey,isSubmitted:h.isSubmitted,isValid:h.isValid,isValidating:h.isValidating,isPristine:h.isPristine,steps:k,currentStep:z||{},isStepPristine:z?z.isPristine:h.isPristine,isStepValid:z?z.isValid:h.isValid,isStepValidating:z?z.isValidating:h.isValidating,isStepSubmitted:z?z.isSubmitted:h.isSubmitted,isFirstStep:(null===(i=k[0])||void 0===i?void 0:i.name)===(null==z?void 0:z.name),isLastStep:(null===(o=k[k.length-1])||void 0===o?void 0:o.name)===(null==z?void 0:z.name)}:{},F(s,"fields")?{values:d(x)}:{},{__connect__:J})},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=formiz-core.umd.production.min.js.map
