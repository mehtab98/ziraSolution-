"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,n=require("react"),r=require("rxjs"),t=require("rxjs/operators"),i=(e=require("prop-types"))&&"object"==typeof e&&"default"in e?e.default:e;function u(){return(u=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e}).apply(this,arguments)}function o(e,n){if(null==e)return{};var r,t,i={},u=Object.keys(e);for(t=0;t<u.length;t++)n.indexOf(r=u[t])>=0||(i[r]=e[r]);return i}function a(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof n?n:String(n)}var s=function(e){return e&&"object"==typeof e&&e.constructor===Object},c=function(e){return Object.keys(e).reduce((function(e,n){return l(n,e)}),e)},l=function(e,n){var r,t;if(e.indexOf(".")<0&&e.indexOf("[")<0)return n;var i=n[e],l=o(n||{},[e].map(a)),d=e.split("."),f=d[0],v=d.slice(1);if(f.match(/\[([0-9]*)\]$/g)){var m,p=f.split(/(\[|\])/g),b=p[0],g=p[2],S=n[b]||[];if(v.length){var y,V=u({},n[b]&&s(n[b][g])?n[b][g]:{},((y={})[v.join(".")]=i,y));S[g]=c(V)}else S[g]=i;return u({},l,((m={})[b]=S,m))}var h=u({},s(n[f])?n[f]:{},((r={})[v.join(".")]=i,r));return u({},l,((t={})[f]=c(h),t))},d=function(e){var n=(e||[]).filter((function(e){return e.isEnabled})).reduce((function(e,n){var r;return u({},e,((r={})[n.name]=n.value,r))}),{});return c(n)},f=function(){return"form-"+Math.random().toString(36).substr(2,9)},v=function(e){var r=n.useRef(e);return r.current=e,r},m=function(e,i){void 0===i&&(i=100);var u=n.useRef(new r.Subject);return{push:function(n){u.current.next(null!=n?n:e.current)},subscription:u.current.pipe(t.throttleTime(i,void 0,{leading:!0,trailing:!0}))}},p=function(e,i){void 0===i&&(i=100);var u=n.useRef(new r.BehaviorSubject(e.current));return{push:function(n){u.current.next(null!=n?n:e.current)},subscription:u.current.pipe(t.throttleTime(i,void 0,{leading:!0,trailing:!0}))}},b={id:f(),resetKey:0,isSubmitted:!1,isValidating:!1,isValid:!0,isPristine:!0,steps:[],initialStepName:null,navigatedStepName:null},g=n.createContext({}),S=function(){return n.useContext(g)},y=function(e){var n=e.navigatedStepName||e.initialStepName;return e.steps.find((function(e){return e.name===n}))},V=new Error("A Formiz field always needs to be a children of a `<Formiz>` component."),h=new Error("A Formiz field (component using a useField hook) always needs a `name` props."),E=new Error("A <FormizStep> always needs to be a children of a `<Formiz>` component."),N=new Error("A <FormizStep> always needs a `name` props."),x=n.createContext({}),F={name:i.string.isRequired,debounce:i.number,defaultValue:i.any,formatValue:i.func,onChange:i.func,required:i.oneOfType([i.bool,i.node]),validations:i.arrayOf(i.shape({rule:i.func,message:i.node,deps:i.arrayOf(i.any)})),asyncValidations:i.arrayOf(i.shape({rule:i.func,message:i.node,deps:i.arrayOf(i.any)})),keepValue:i.bool},O={debounce:100,defaultValue:null,formatValue:function(e){return e},onChange:function(){},required:!1,validations:[],asyncValidations:[],keepValue:!1},P=function(e,n){return!0===e||e===n||"object"==typeof e&&!!e[n]};exports.Formiz=function(e){var r=e.autoForm,t=void 0!==r&&r,i=e.children,o=void 0===i?"":i,a=e.connect,s=void 0===a?{}:a,c=e.id,l=void 0===c?f():c,S=e.onChange,V=void 0===S?function(){}:S,h=e.onSubmit,E=void 0===h?function(){}:h,N=e.onValidSubmit,x=void 0===N?function(){}:N,F=e.onInvalidSubmit,O=void 0===F?function(){}:F,P=e.onValid,j=void 0===P?function(){}:P,R=e.onInvalid,w=void 0===R?function(){}:R,J=n.useRef(u({},b,{id:l})),k=n.useRef([]),C=n.useRef({}),K=v(s.__connect__||function(){}),U=v(V),_=v(E),q=v(x),z=v(O),M=v(j),T=v(w),D=p(J),I=p(k),A=m(k),B=m(J),L=function(){var e=k.current.every((function(e){var n,r,t;return!(null==e||null===(n=e.errors)||void 0===n?void 0:n.length)&&!(null==e||null===(r=e.asyncErrors)||void 0===r?void 0:r.length)&&!(null==e||null===(t=e.externalErrors)||void 0===t?void 0:t.length)}));return e?M.current():T.current(),e},$=function(e){return k.current.filter((function(n){return n.stepName===e})).every((function(e){return null==e?void 0:e.isPristine}))},G=function(e){return k.current.filter((function(n){return n.stepName===e})).some((function(e){return null==e?void 0:e.isValidating}))},H=function(e){var n=u({},J.current,e);JSON.stringify(n)!==JSON.stringify(J.current)&&(J.current=n,D.push())},Q=function(e){var n=J.current.steps.filter((function(e){return e.isEnabled})),r=n.findIndex((function(n){return n.name===e}));r<0||H({navigatedStepName:n[r].name})},W=function(){var e=J.current.steps.filter((function(e){return e.isEnabled})),n=e.findIndex((function(e){var n;return e.name===(null===(n=y(J.current))||void 0===n?void 0:n.name)}));n===e.length-1||Q(e[n+1].name)},X=function(e){e&&e.preventDefault(),H({isSubmitted:!0,steps:J.current.steps.map((function(e){return u({},e,{isSubmitted:!0})}))});var n=d(k.current);J.current.isValid&&!J.current.isValidating?q.current(n):z.current(n),_.current(n)},Y=function(){H({isValid:L(),isPristine:k.current.every((function(e){return null==e?void 0:e.isPristine})),isValidating:k.current.some((function(e){return null==e?void 0:e.isValidating})),steps:J.current.steps.map((function(e){return u({},e,{isValid:(n=e.name,k.current.filter((function(e){return e.stepName===n})).every((function(e){var n,r,t;return!(null==e||null===(n=e.errors)||void 0===n?void 0:n.length)&&!(null==e||null===(r=e.asyncErrors)||void 0===r?void 0:r.length)&&!(null==e||null===(t=e.externalErrors)||void 0===t?void 0:t.length)}))),isPristine:$(e.name),isValidating:G(e.name)});var n}))})},Z={submit:X,submitStep:function(e){var n,r;e&&e.preventDefault(),H({steps:J.current.steps.map((function(e){var n;return u({},e,{isSubmitted:e.name===(null===(n=y(J.current))||void 0===n?void 0:n.name)||e.isSubmitted})}))});var t=y(J.current);if((null==t?void 0:t.isValid)&&!(null==t?void 0:t.isValidating)){var i=J.current.steps.filter((function(e){return e.isEnabled})),o=null===(n=y(J.current))||void 0===n?void 0:n.name;(null===(r=i[i.length-1])||void 0===r?void 0:r.name)===o?X():W()}},setFieldsValues:function(e){void 0===e&&(e={}),k.current=function(e,n){if(void 0===n&&(n={}),!n)return e;var r=e.map((function(e){var r;return u({},e,{value:null!==(r=n[e.name])&&void 0!==r?r:e.value})}));return[].concat(r)}(k.current,e),A.push()},invalidateFields:function(e){void 0===e&&(e={}),k.current=function(e,n){if(void 0===n&&(n={}),!n)return e;var r=e.map((function(e){return u({},e,{externalErrors:n[e.name]?[n[e.name],e.externalErrors]:e.externalErrors})}));return[].concat(r)}(k.current,e),A.push()},getFieldStepName:function(e){var n,r;return null!==(n=null===(r=k.current.find((function(n){return e===n.name})))||void 0===r?void 0:r.stepName)&&void 0!==n?n:null},goToStep:Q,nextStep:W,prevStep:function(){var e=J.current.steps.filter((function(e){return e.isEnabled})),n=e.findIndex((function(e){var n;return e.name===(null===(n=y(J.current))||void 0===n?void 0:n.name)}));0===n||Q(e[n-1].name)},reset:function(){var e;H(u({},e=J.current,{resetKey:e.resetKey+1,isSubmitted:!1,isValid:!0,navigatedStepName:null,steps:e.steps.map((function(e){return u({},e,{isSubmitted:!1,isVisited:!1})}))})),C.current={},B.push()}},ee={formStateRef:J,fieldsRef:k,actions:{updateStep:function(e){H(function(e,n){if(!n||!n.name)return e;var r=e.steps.findIndex((function(e){return e.name===n.name})),t=e.steps[r],i=u({},t||{},n);if(JSON.stringify(i)===JSON.stringify(t))return e;var o=[].concat(e.steps);t?o[r]=i:o.push(i);var a=o.sort((function(e,n){return e.order-n.order})),s=a.filter((function(e){return e.isEnabled}));return u({},e,{initialStepName:s.length?s[0].name:null,steps:a})}(J.current,e)),Y()},unregisterStep:function(e){H(u({},function(e,n){return n?u({},e,{steps:e.steps.filter((function(e){return e.name!==n}))}):e}(J.current,e),{isValid:L()})),Y()},registerField:function(e){delete C.current[e.name],k.current=function(e,n){if(!n)return e;var r=e.find((function(e){return e.id===n.id})),t=e.filter((function(e){return e.id!==n.id}));return JSON.stringify(n)===JSON.stringify(r)?e:[].concat(t,[u({},n)])}(k.current,e),I.push(),U.current(d(k.current)),Y()},updateField:function(e){k.current=function(e,n){if(!n)return e;var r=e.find((function(e){return e.id===n.id})),t=e.filter((function(e){return e.id!==n.id}));return JSON.stringify(n)===JSON.stringify(r)?e:[].concat(t,[u({},n)])}(k.current,e),I.push(),U.current(d(k.current)),Y()},unregisterField:function(e,n){n&&(C.current[e.name]=e.value),k.current=function(e,n){if(!n)return e;var r=e.filter((function(e){return e.id!==n}));return[].concat(r)}(k.current,e.id),I.push(),U.current(d(k.current)),Y()}},formMethods:Z,keepValuesRef:C,subjects:{onFormUpdate:D,onFieldsUpdate:I,onExternalFieldsUpdate:A,onReset:B}};return n.useEffect((function(){K.current(ee)}),[]),n.createElement(g.Provider,{value:ee},t?n.createElement("form",{noValidate:!0,onSubmit:X},o):o)},exports.FormizStep=function(e){var r,t=e.as,i=void 0===t?"div":t,a=e.children,s=e.name,c=e.label,l=e.order,d=e.isEnabled,f=void 0===d||d,v=e.style,m=void 0===v?{}:v,p=o(e,["as","children","name","label","order","isEnabled","style"]);if(!s)throw N;var g=S(),y=g.formStateRef,V=g.actions,h=g.subjects;if(!h||!V)throw E;var F=n.useState(null!==(r=null==y?void 0:y.current)&&void 0!==r?r:b),O=F[0],P=F[1],j=n.useState({name:s,label:c,isVisited:!1,order:null!=l?l:0}),R=j[0],w=j[1],J=O.navigatedStepName?O.navigatedStepName===s:O.initialStepName===s;return n.useEffect((function(){var e=h.onFormUpdate.subscription.subscribe(P);return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){O.navigatedStepName===s&&!R.isVisited&&J&&w((function(e){return u({},e,{isVisited:!0})}))})),n.useEffect((function(){V.updateStep(u({},R,{isEnabled:f}))}),[R,f]),n.useEffect((function(){return function(){V.unregisterStep(s)}}),[s]),f?n.createElement(x.Provider,{value:{name:s}},n.createElement(i,Object.assign({style:u({},m,{display:J?null:"none"})},p),f&&a)):null},exports.fieldDefaultProps=O,exports.fieldPropTypes=F,exports.useField=function(e){var r,t,i,o,a,s=e.name,c=e.debounce,l=void 0===c?O.debounce:c,d=e.defaultValue,f=void 0===d?O.defaultValue:d,m=e.formatValue,p=void 0===m?O.formatValue:m,g=e.onChange,y=void 0===g?O.onChange:g,E=e.required,N=void 0===E?O.required:E,F=e.validations,P=void 0===F?O.validations:F,j=e.asyncValidations,R=void 0===j?O.asyncValidations:j,w=e.keepValue,J=void 0===w?O.keepValue:w;if(!s)throw h;var k=S(),C=k.formStateRef,K=k.actions,U=k.subjects,_=k.keepValuesRef;if(!U||!K||!_)throw V;var q=n.useRef(!0),z=n.useContext(x),M=null==z?void 0:z.name,T=n.useState(null!==(r=null==C?void 0:C.current)&&void 0!==r?r:b),D=T[0],I=T[1],A=null!==(t=null===(i=_.current)||void 0===i?void 0:i[s])&&void 0!==t?t:f,B=n.useState({id:"field-"+Math.random().toString(36).substr(2,9),resetKey:0,value:A,valueDebounced:A,errors:[],asyncErrors:[],externalErrors:[],isValidating:!1,isPristine:!0,isEnabled:!0}),L=B[0],$=B[1],G=v(L),H=v(s),Q=v(M),W=v(function(e,n){return n||""===n?[].concat(e,[{rule:function(e){return!!e||0===e},message:!0!==n?n:""}]):e}(P||[],N)),X=v(R||[]),Y=v(l),Z=v(y),ee=v(p),ne=v(f),re=v(J),te=D.navigatedStepName||D.initialStepName,ie=D.steps.find((function(e){return e.name===te}))||null;n.useEffect((function(){var e=U.onFormUpdate.subscription.subscribe(I);return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){var e=U.onExternalFieldsUpdate.subscription.subscribe((function(e){var n=e.find((function(e){return e.id===G.current.id}));n&&JSON.stringify(n)!==JSON.stringify(G.current)&&$(n)}));return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){var e=U.onReset.subscription.subscribe((function(){$((function(e){return u({},e,{error:[],externalErrors:[],resetKey:e.resetKey+1,isPristine:!0,value:ne.current})})),Z.current(ee.current(ne.current),ne.current)}));return function(){return e.unsubscribe()}}),[]),n.useEffect((function(){var e=function(){try{var e=(W.current||[]).reduce((function(e,n){return n.rule(L.value)?e:[].concat(e,[n.message])}),[]),n=!e.length&&!!(X.current||[]).length;return $((function(r){return u({},r,{errors:e,asyncErrors:[],valueDebounced:r.value,isValidating:n})})),n?Promise.resolve(Promise.all((X.current||[]).map((function(e){try{return Promise.resolve(e.rule(L.value)).then((function(n){return u({},e,{isValid:n})}))}catch(e){return Promise.reject(e)}})))).then((function(e){if(q.current&&L.value===G.current.value){var n=e.reduce((function(e,n){return n.isValid?e:[].concat(e,[n.message])}),[]);$((function(e){return u({},e,{asyncErrors:n,isValidating:!1})}))}})):Promise.resolve()}catch(e){return Promise.reject(e)}};if(!Y.current)return e(),function(){};var n=setTimeout((function(){e()}),Y.current);return function(){return clearTimeout(n)}}),[JSON.stringify(L.value),JSON.stringify(null===(o=[].concat(P||[],R||[]))||void 0===o?void 0:o.reduce((function(e,n){return[].concat(e,n.deps||[],[n.message])}),[]))]),n.useEffect((function(){return K.registerField(u({},G.current,{name:H.current,stepName:Q.current,value:ee.current(G.current.value)})),function(){K.unregisterField(u({},G.current,{name:H.current,stepName:Q.current,value:ee.current(G.current.value)}),re.current)}}),[]),n.useEffect((function(){K.updateField(u({},L,{name:s,stepName:M,value:ee.current(L.value)}))}),[s,M,JSON.stringify(L)]),n.useEffect((function(){return function(){q.current=!1}}),[]);var ue,oe,ae=M&&ie&&te===M?ie.isSubmitted:D.isSubmitted,se=[].concat(L.externalErrors,L.asyncErrors,L.errors);return{errorMessage:se[0],errorMessages:se,id:(ue=(null==C||null===(a=C.current)||void 0===a?void 0:a.id)||"",oe=s,"formiz-"+ue+"-field-"+oe),isPristine:L.isPristine,isSubmitted:ae,isValid:!se.length,isValidating:L.isValidating,setValue:function(e){$((function(n){return u({},n,{externalErrors:[],value:e,isPristine:!1})})),Z.current(ee.current(e),e)},value:L.value,valueDebounced:L.valueDebounced,resetKey:L.resetKey}},exports.useForm=function(e){var r,t,i,o,a=(void 0===e?{}:e).subscribe,s=void 0===a||a,c=S(),l=c.formStateRef,f=c.fieldsRef,m=c.subjects,p=n.useState(c.formMethods),g=p[0],y=p[1],V=n.useState(null!==(r=null==l?void 0:l.current)&&void 0!==r?r:b),h=V[0],E=V[1],N=n.useState(null!==(t=null==f?void 0:f.current)&&void 0!==t?t:[]),x=N[0],F=N[1],O=v(x),j=n.useRef([]),R=function(e){if(e&&P(s,"form")){var n=e.subscription.subscribe(E);j.current.push(n)}},w=function(e){if(e&&P(s,"fields")){var n="object"==typeof s&&"object"==typeof s.fields?s.fields:null,r=e.subscription.subscribe((function(e){var r=n?e.filter((function(e){return n.includes(e.name)})):e;JSON.stringify(O.current)!==JSON.stringify(r)&&F(r)}));j.current.push(r)}},J=n.useCallback((function(e){var n=e.subjects;y(e.formMethods),R(null==n?void 0:n.onFormUpdate),w(null==n?void 0:n.onFieldsUpdate)}),[]);n.useEffect((function(){R(null==m?void 0:m.onFormUpdate),w(null==m?void 0:m.onFieldsUpdate)}),[]),n.useEffect((function(){return function(){j.current.forEach((function(e){return null==e?void 0:e.unsubscribe()}))}}),[]);var k=h.steps.filter((function(e){return e.isEnabled})).map((function(e,n){var r=e.isSubmitted,t=e.isPristine,i=e.isValidating,u=e.isValid,o=e.isVisited;return{index:n,name:e.name,label:e.label,isPristine:null!=t&&t,isSubmitted:null!=r&&r,isValid:null!=u&&u,isValidating:null!=i&&i,isVisited:null!=o&&o}})).map((function(e,n){return u({},e,{index:n})})),C=k.find((function(e){return e.name===(h.navigatedStepName||h.initialStepName)}))||null;return u({},g,P(s,"form")?{resetKey:h.resetKey,isSubmitted:h.isSubmitted,isValid:h.isValid,isValidating:h.isValidating,isPristine:h.isPristine,steps:k,currentStep:C||{},isStepPristine:C?C.isPristine:h.isPristine,isStepValid:C?C.isValid:h.isValid,isStepValidating:C?C.isValidating:h.isValidating,isStepSubmitted:C?C.isSubmitted:h.isSubmitted,isFirstStep:(null===(i=k[0])||void 0===i?void 0:i.name)===(null==C?void 0:C.name),isLastStep:(null===(o=k[k.length-1])||void 0===o?void 0:o.name)===(null==C?void 0:C.name)}:{},P(s,"fields")?{values:d(x)}:{},{__connect__:J})};
//# sourceMappingURL=formiz-core.cjs.production.min.js.map
